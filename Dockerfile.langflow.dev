# Langflow をソースからビルドするための開発用 Dockerfile
# テスト用に任意の Git ブランチ/リポジトリからビルドできる

FROM python:3.12-slim AS builder

# 環境変数の設定
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1
ENV RUSTFLAGS="--cfg reqwest_unstable"

# git リポジトリとブランチのビルド引数を受け取る
ARG GIT_REPO=https://github.com/langflow-ai/langflow.git
ARG GIT_BRANCH=main

WORKDIR /app

# システム依存関係のインストール
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    git \
    ca-certificates \
    gnupg \
    npm \
    rustc cargo pkg-config libssl-dev \
    && rm -rf /var/lib/apt/lists/*

# 高速な Python パッケージ管理のために uv をインストールする
RUN pip install uv

# リポジトリをクローンして指定されたブランチをチェックアウトする
RUN echo "Cloning ${GIT_REPO} branch ${GIT_BRANCH}..." && \
    git clone --depth 1 --branch ${GIT_BRANCH} ${GIT_REPO} /app

# バックエンド依存関係のインストール
RUN uv sync --frozen --no-install-project --no-editable --extra postgresql

# フロントエンドのビルド（ピークメモリ使用量を削減するためにステップを分割）
WORKDIR /app/src/frontend
# 最初に依存関係をインストールする
RUN npm ci --maxsockets 1
# メモリを抑えてビルド - ほとんどのシステムで 2GB が安全
RUN NODE_OPTIONS="--max_old_space_size=2048 --max-semi-space-size=128" npm run build
# ビルド済みフロントエンドをコピーする
RUN mkdir -p /app/src/backend/base/langflow/frontend && \
    cp -r build/* /app/src/backend/base/langflow/frontend/

# アプリディレクトリに戻りプロジェクトをインストールする
WORKDIR /app
RUN uv sync --frozen --no-dev --no-editable --extra postgresql

# ポートの公開
EXPOSE 7860

# バックエンドサーバーを起動する
CMD ["uv", "run", "langflow", "run", "--host", "0.0.0.0", "--port", "7860"]
